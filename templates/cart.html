{% load static %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Your Cart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
         body {
      font-family: "Segoe UI", Arial, sans-serif;
      color: #d30640;
      height: 100vh;
      background: linear-gradient(to right, #e83fb8, #f5f5dc);
      background-attachment: fixed;
    }

    nav {
      background-color: rgba(0, 0, 0, 0.6);
      padding: 12px 50px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }


    .nav-links {
      list-style: none;
      display: flex;
      align-items: center;
    }

    .nav-links li {
      position: relative;
    }


    .nav-links a:hover, .dropdown:hover .dropbtn {
      background-color: rgba(255, 255, 255, 0.15);
      border-radius: 6px;
    }



  
      .container {
      max-width: 1000px;
      margin: 80px auto;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    @media (max-width: 768px) {
      nav {
        flex-direction: column;
        text-align: center;
      }
      .nav-links {
        flex-direction: column;
      }}



      button {
      width: 100%;
      padding: 12px;
      background-color: #f15aa8;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    button:hover {
      background-color: #c30363;
    }

  </style>
</head>
<body class="p-4">
  <nav>
    <ul class="nav-links" style="list-style:none; display:flex; gap:8px; align-items:center; margin:0;"></ul>
      <li><a href="{% url 'homepage' %}" style="color:white; text-decoration:none;">Home</a></li>
      </ul>
  </nav>
  <h2>Your Cart</h2>
     
      
<div class="container">
  {% if cart_items %}
    <table class="table">
      <thead>
        <tr><th>Product</th><th>Qty</th><th>Price</th><th>Subtotal</th><th></th></tr>
      </thead>
      <tbody>
        {% for item in cart_items %}
        <!-- added data-price, data-remove-url and data-update-url -->
        <tr data-id="{{ item.id }}"
            data-price="{{ item.price|default:0 }}"
            data-remove-url="{% url 'remove_from_cart' item.id %}"
            data-update-url="{% url 'update_cart' item.id %}">
          <td>
            {% if item.image_url %}
              <img src="{{ item.image_url }}" alt="{{ item.title }}" class="me-2">
            {% endif %}
            <strong>{{ item.title }}</strong>
          </td>
          <td>
            <input class="qty-input" type="number" value="{{ item.qty }}" min="1" style="width:70px;">
          </td>
          <td>{{ item.price|default:"0.00" }}</td>
          <td class="subtotal">{{ item.subtotal|default:"0.00" }}</td>
          <td>
            <button class="btn-remove btn btn-sm btn-outline-danger">Remove</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="d-flex justify-content-end">
      <h4>Total: <span id="cartTotal">{{ total }}</span></h4>
    </div>
    
    <div class="mt-3">
      <form method="post" action="{% url 'checkout' %}">
        {% csrf_token %}
        <button type="submit">Checkout</button>
      </form>
    </div>
    </div>
  {% else %}
    <p>Your cart is empty. <a href="{% url 'homepage' %}">Continue shopping</a></p>
  {% endif %}

  <!-- JS for remove/qty (uses fetch to server endpoints) -->
<script>
  // simple getCookie for CSRF (Django-style)
  function getCookie(name) {
    const match = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return match ? match.pop() : '';
  }

  const csrftoken = getCookie('csrftoken');

  function recalcRow(tr) {
    const price = parseFloat(tr.dataset.price || 0) || 0;
    const qty = parseInt(tr.querySelector('.qty-input').value || 0) || 0;
    const subtotal = (price * qty).toFixed(2);
    const subtotalCell = tr.querySelector('.subtotal');
    if (subtotalCell) subtotalCell.textContent = subtotal;
  }

  function recalcTotal() {
    let total = 0;
    document.querySelectorAll('tr[data-id]').forEach(tr => {
      const price = parseFloat(tr.dataset.price || 0) || 0;
      const qty = parseInt(tr.querySelector('.qty-input').value || 0) || 0;
      total += price * qty;
    });
    const totalEl = document.getElementById('cartTotal');
    if (totalEl) totalEl.textContent = total.toFixed(2);
  }

  // delegated click for remove buttons
  document.addEventListener('click', async function(e){
    if (e.target.matches('.btn-remove')) {
      const tr = e.target.closest('tr');
      const removeUrl = tr && tr.dataset.removeUrl;
      if (!removeUrl) {
        console.error('Remove URL missing for row', tr);
        return alert('Remove URL missing — check template.');
      }

      try {
        const res = await fetch(removeUrl, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        if (!res.ok) {
          const body = await res.text().catch(()=>null);
          console.error('Remove failed', res.status, body);
          return alert('Remove failed (server error). See console for details.');
        }

        const data = await res.json().catch(()=>({ok:false}));
        if (data.ok) {
          tr.remove();
          recalcTotal();
        } else {
          console.error('Remove returned not ok', data);
          alert('Remove failed: ' + (data.error || 'unknown'));
        }
      } catch (err) {
        console.error('Fetch error on remove', err);
        alert('Network error while removing item.');
      }
    }
  });

  // qty change handler
  document.querySelectorAll('.qty-input').forEach(input=>{
    input.addEventListener('change', async function(){
      const tr = input.closest('tr');
      const id = tr && tr.dataset.id;
      if (!id) return;

      let qty = parseInt(input.value || 0);
      if (qty <= 0) { qty = 1; input.value = 1; }

      // prefer data-update-url on the row
      const updateUrl = tr.dataset.updateUrl;
      if (!updateUrl) {
        console.error('Update URL missing for row', tr);
        alert('Update URL missing — check template.');
        return;
      }

      try {
        const res = await fetch(updateUrl, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: 'qty=' + encodeURIComponent(qty)
        });

        if (!res.ok) {
          const body = await res.text().catch(()=>null);
          console.error('Update failed', res.status, body);
          return alert('Update failed (server error). Check console for details.');
        }

        const data = await res.json().catch(()=>({ok:false}));
        if (data.ok) {
          recalcRow(tr);
          recalcTotal();
        } else {
          console.error('Update returned not ok', data);
          alert('Update failed: ' + (data.error || 'unknown'));
        }
      } catch (err) {
        console.error('Fetch error on update', err);
        alert('Network error while updating quantity.');
      }
    });
  });

  // initial recalc at load
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('tr[data-id]').forEach(tr => recalcRow(tr));
    recalcTotal();
  });
</script>

</body>
</html>
